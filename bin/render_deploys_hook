#!/usr/bin/env ruby
# Default rendering hook. Uses built in `templater` to render out all files
# underneath kubernetes/ directory, recursively.

require 'json'
require 'yaml'

TEMPLATING_SUFFIX = '.erb'

def render_deploys(config, output_root)
  prefix = 'kubernetes/'
  Dir["#{prefix}**/*.y*ml*"].each do |yml|
    # PREFIX/b/c/foo.yml.in -> foo.yml
    output_base = File.basename(yml, TEMPLATING_SUFFIX)

    # PREFIX/b/c/foo.yml.in -> b/c
    subdir = File.dirname(yml[prefix.size..-1])

    # PREFIX/b/c/foo.yml.in -> output/b/c/foo.yml
    output_dir = File.join(output_root, subdir)
    output_file = File.join(output_dir, output_base)

    FileUtils.mkdir_p output_dir

    if yml.end_with? TEMPLATING_SUFFIX
      # File needs to be templated with templater.
      render(config, yml, output_file)
    else
      # File is not templatable, and is copied verbatim.
      FileUtils.copy(yml, output_file)
    end

    # Bonus: YAML validate the output.
    begin
      YAML.load(File.read(output_file))
    rescue => e
      raise "Failed to YAML validate #{output_file} (generated from #{yml}): #{e}"
    end
  end
end

def render(config, template, output_file)
  cmd = "bundle exec templater --values #{config} --template #{template} > #{output_file}"
  ok = system(cmd)
  raise "Error running #{cmd}: exit status #{$?}" unless $? == 0
end

def main(argv)
  config = argv[0]
  output_root = argv[1]
  render_deploys(config, output_root)
end

main(ARGV)
