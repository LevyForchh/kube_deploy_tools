
<!-- TOC -->

- [Installation](#installation)
- [Configuration](#configuration)
  - [Directory structure](#directory-structure)
  - [`deploy.yaml`](#deployyaml)
  - [kubernetes/](#kubernetes)
- [Usage](#usage)
- [Continuous Integration Setup in Jenkins](#continuous-integration-setup-in-jenkins)

<!-- /TOC -->

KDT is intended to be used as part of a deployment pipeline to release published
Docker images from our image registry and published Kubernetes manifests
from our artifact registry.

Steps in your CI build would fulfill the deployment chain and include:
1. packaging your app and building the Docker image,
2. using KDT to tag and push your Docker image,
3. using KDT to render and push all Kubernetes manifests.

This translates to the following example of a CI build script:
```bash
# (1) Build images
docker build -t local-registry/<image> # for each Docker image in your project
# (2) Push images to image registry
bundle exec kdt push <images...> # for all Docker images built in your project
# (3a) Render Kubernetes deploy artifacts
bundle exec kdt generate
# (3b) Push Kubernetes deploy artifacts to Artifactory
bundle exec kdt publish
```

This results in the following:

- all Docker images tagged and pushed at a well-known tag
- all Kubernetes manifests referencing the same Docker images at the same
well-known tag in a single deploy artifact

Below are installation steps for KDT along with default configuration.

# Installation

See [Install section](../README.md).

# Configuration

KDT commands are configured via a `deploy.yaml` file.

By default, KDT will
* look for the `deploy.yaml` in your repo root,
* look for your templated Kubernetes manifests under the `kubernetes/`
  path of your repo root, and
* output artifacts with Kubernetes manifests into the `build/kubernetes/`
  path of your repo root.

Examples of deploy.yaml and the `kubernetes/` folder are below.

## Directory structure

```
my-project/
  Gemfile                       # contains gem 'kube_deploy_tools'
  Gemfile.lock
  deploy.yaml                   # deployment config for your project
  kubernetes/
  build/kubernetes/             # don't commit this directory, it's generated by kube_deploy_tools
  .gitignore                    # the build/ directory is git ignored
```

## `deploy.yaml`

For a more comprehensive example, see
[examples/projects/deploy.yaml](../examples/project/deploy.yaml).

```yaml
version: 2
default_flags:
  pull_policy: IfNotPresent
artifacts:
  - name: local-staging
    image_registry: local
    flags:
      target: local
      environment: staging
      cloud: local
      pull_policy: Always
  - name: colo-service-prod
    image_registry: aws
    flags:
      target: colo-service
      environment: prod
      cloud: colo
  - name: colo-service-staging
    image_registry: aws
    flags:
      target: colo-service
      environment: staging
      cloud: colo
  - name: dist-prod
    image_registry: gcp
    flags:
      target: dist
      environment: prod
      cloud: gcp
flavors:
  default: {}
image_registries:
  - name: aws
    driver: aws
    prefix: ***REMOVED***
    config:
      region: us-west-2
  - name: gcp
    driver: gcp
    prefix: ***REMOVED***
  - name: local
    driver: noop
    prefix: local-registry
```

## kubernetes/

Use the `kubernetes/` directory for storing your Kubernetes manifests
in your project (or Java module).

File types can either be `.yaml` or `.yaml.erb`, and files may be stored into
subdirectories. For example:

```
kubernetes/
  configmap-my-todo-list.yaml
  my-todo-app/
    dep-my-todo-app.yaml.erb
    service-my-todo-app.yaml
```

The manifests in the `kubernetes/` directory will be rendered by
`kube_deploy_tools` into the `build/kubernetes/` directory, where deploy
artifacts will be compressed and published to Artifactory.

Thus, add the `build/` directory to your .gitignore file.

# Usage

After writing your `deploy.yaml` and with your `kubernetes/` manifests,
you can now continue to configure your CI pipeline, and you can test
KDT by running the example below locally:

```bash
# To build and push your image to an image registry specified in
# your deploy.yaml, run
docker build -t local-registry/my-image .
bundle exec kdt push my-image --registry=gcp

# To generate Kubernetes manifests from your templates under kubernetes/
# to build/kubernetes/, run
bundle exec kdt generate
```

# Continuous Integration Setup in Jenkins

Please see [documentation/liveramp_jenkins.md](liveramp_jenkins.md) for adding
credentials to your Jenkins build.
