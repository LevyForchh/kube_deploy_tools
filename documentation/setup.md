
# Setup

## Install the Gem

Install the `kube_deploy_tools` gem in your project.

Gemfile:
```ruby
source 'https://gemserver.***REMOVED***'

group :kdt do
  gem 'kube_deploy_tools', '~> 1.0'
end
```

```bash
bundle install
```

If you only need to install kdt (typically only applies to deployment servers like rampmaster)
```bash
bundle install --with kdt --without default development test
```

## Create deploy.yml

Add a deploy.yml to the root of your project.

```bash
cat << EOF > deploy.yml
deploy:
  clusters:
    - target: local
      environment: staging
    - target: colo-service
      environment: prod
    - target: colo-service
      environment: staging
  flavors:
    default: {}
EOF
```

Edit deploy.yml to only include the Kubernetes clusters your project will
deploy to.

For a full list of supported clusters, see
[examples/projects/deploy.yml](../examples/project/deploy.yml).

## Create Kubernetes manifests into kubernetes/

Use your project's `kubernetes/` directory for storing your Kubernetes manifests.

File types can either be `.yaml` or `.yaml.erb`, and files may be stored into
subdirectories. For example:

```
kubernetes/
  configmap-my-todo-list.yaml
  my-todo-app/
    dep-my-todo-app.yaml.erb
    service-my-todo-app.yaml
```

See [documentation/kube_manifests_with_erb.md](kube_manifests_with_erb.md)
for writing Kubernetes manifests with ERB.

The manifests in the `kubernetes/` directory will be rendered by
`kube_deploy_tools` into the `build/kubernetes/` directory, where deploy
artifacts will be compressed and published to Artifactory.

Thus, add the `build/` directory to your .gitignore file.

## Set up Jenkins build steps

The Jenkins build should run on Docker-enabled Jenkins workers.
In General > Restrict where this project can be run, set the Label Expression to
`docker2`.

A Jenkins build step is required to build, tag, and push all of your Docker images.
See [documentation/deploy.md](deploy.md) for more.

```
# In your project's Jenkins build script

bundle exec kdt publish_container # for each Docker image built
```

A Jenkins build step is required to render Kubernetes manifests and deploy
artifacts and push these release artifacts.

```bash
# In your project's Jenkins build script

bundle exec kdt render_deploys
bundle exec kdt publish_artifacts
```

A Jenkins build step is required to publish your project's deploy artifacts to
Artifactory. See the image below and instructions.

![Jenkins Artifactory upload](jenkins_build.png)

* Under Bindings, add a username and password (separated) with
`ARTIFACTORY_USERNAME` as the Username Variable,
`ARTIFACTORY_PASSWORD` as the Password Variable, and
`jenkins_publisher/****** (***REMOVED***)` selected as the specific
credentials. See below.

## Directory structure

```
project/root/
  Gemfile                       # contains gem 'kube_deploy_tools'
  Gemfile.lock
  deploy.yml                    # deployment config for your project
  .gitignore                    # the build/ directory is git ignored
  build/                        # don't commit this directory, it's generated by kube_deploy_tools
    kubernetes/
      artifactory.json          # generated file used in your Jenkins build
  scripts/
    render_deploys_hook
```

