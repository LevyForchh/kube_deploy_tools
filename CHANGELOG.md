
# Changelog

## 2.x

### Major changes
* `kdt publish_artifacts` renamed to `kdt publish`. The former subcommand will
  be removed in 3.0, but continues to work for now.
* `kdt publish_containers` renamed to `kdt push`. The former subcommand will
  be removed in 3.0, but continues to work for now.
* `kdt render_deploys` renamed to `kdt generate`. The former subcommand will
  be removed in 3.0, but continues to work for now.
* `kdt sweeper` renamed to `kdt expire`. The former subcommand will
  be removed in 3.0, but continues to work for now.
* `kdt templater`, `kdt render_deploys_hook`, and `kdt make_configmap` are
  disappearing in 3.0 and have been marked as such. They remain for now.

### Breaking Changes
* For `kdt deploy`, `--context` is now a required argument.
  * To view your contexts, see `kubectl config get-contexts`.
* For `kdt publish_container`, in `deploy.yaml`,
  * `image_registries` has been added as a mandatory entry in each deploy.yaml.
    KDT no longer has built-in knowledge about any image registry target and
    you must specify your own.

For example,
```yaml
image_registries:
  - name: aws
    driver: aws
    prefix: ***REMOVED***
    config:
      region: us-west-2
  - name: gcp
    driver: gcp
    prefix: ***REMOVED***
```

* You must add any new configuration for a cluster deploy target in `deploy.yaml`
as a new concept called an `artifact`.

For example,
```yaml
artifacts:
  - name: dist-prod
    flags:
      target: ***REMOVED***-dist
      environment: prod
      cloud: gcp
      image_registry: ***REMOVED***
      pull_policy: IfNotPresent
  - name: dist-staging
    flags:
      target: ***REMOVED***-dist
      environment: staging
      cloud: gcp
      # ... etc
```

`.deploy.clusters` has been renamed to `.artifacts`, and the concept of
a combination of `--target`, `--environment`, and `--flavor` has been
removed and replaced by the concept of an artifact.

This `deploy.yaml` change precipitates into `kdt render_deploys`,
`kdt publish_artifacts`, and `kdt deploy`, as in the example below.

*Note that old artifacts generated by KDT 1.x will not be deployable by KDT 2.x,
and you'll have to deploy such artifacts with KDT 1.x.*

```bash
kdt render_deploys
# each named artifact is output to a directory like build/kubernetes/artifact
# instead of build/kubernetes/target/environment/flavor/

kdt publish_artifacts
# each named artifact is published

kdt deploy \
  --project=<project> \
  --build=<build> \
  --artifact=<artifact> \
  --context=<context>
# the named artifact is deployed to the specified context

```

* For `kdt render_deploys` and `kdt deploy`, `--include`, `--exclude`,
`--include-dir`, and `--exclude-dir` are now supported.

* For `kdt render_deploys`, in `deploy.yaml`, `.artifacts` supports
optional `.include_dir` and `.exclude_dir` fields.

For example, an artifact containing only the `nginx/` directory can be specified
as:

```yaml
artifacts:
  - name: dist-staging
    flags:
      target: ***REMOVED***-dist
      environment: staging
      cloud: gcp
    include_dir:
      - nginx/
```

* For `kdt render_deploys`, in `deploy.yaml`,
  * `extra_flags` has been renamed to `flags`
  * `target`, `environment`, `cloud`, `image_registry`, and `pull_policy` are required `flags`

For example,
```yaml
artifacts:
  - name: colo-service-prod
    flags:
      target: colo-service
      environment: prod
      cloud: colo
      image_registry: 123456789.dkr.ecr.us-west-2.amazonaws.com
      pull_policy: IfNotPresent
```

* `deploy.yml` is deprecated in favor of `deploy.yaml`

* kdt will now only surface the `kdt` binary as a singular entrypoint. This means
that if you were previously invoking the kdt subcommands directly (eg.
`bundle exec publish_container` or
`bundle binstub kube_deploy_tools && bin/render_deploys`) then you will be
unable to invoke the binaries.

The fix is to modify your build script to execute commands through the kdt
entrypoint. For instance:

```bash
bundle exec publish_artifacts

# becomes

bundle exec kdt publish_artifacts
```

Please search for invocations of the following binaries and update them to use
the kdt entrypoint:

```
deploy
make_configmap
publish_artifacts
publish_container
render_deploys
render_deploys_hook
sweeper
templater
toolbox
```

* The `config['image_tag']` value no longer contains the current branch,
  only the git sha and Jenkins build id.
* `toolbox` is no longer part of KDT. It relied on a data model which we
  have discarded in 2.x (the concept of target/environment being linked
  to a specific registry.)

## 1.4.x

### Breaking Changes
kdt will now default to an image pull policy of  `IfNotPresent`,changed from `Always`.

Any yaml templates using `imagePullPolicy: <%= config["pull_policy"] %>` will now default to not pulling an image tag if that tag is already on the node.
* If you have always used kdt to template out the image tag of your containers, this change does not affect you.
* However, if you have been using a static image tag that you keep replacing and rely on `imagePullPolicy: Always` to update that tag on nodes, then you will have to set that explicitly in your kubernetes yamls

## 1.3.x

### Breaking Changes
Support for the Jenkins Generic Artifactory Integration is removed and
artifactory.json is no longer generated.

Instead, a new command `publish_artifacts` will upload release artifacts
to Artifactory.

In your Jenkins build script, add `bundle exec kdt publish_artifacts`.

Please make the following changes in your Jenkins build.

* Under Build Environment, un-check Generic Artifactory Integration to disable.
* Under Bindings, add a username and password (separated) with
`ARTIFACTORY_USERNAME` as the Username Variable,
`ARTIFACTORY_PASSWORD` as the Password Variable, and
`jenkins_publisher/****** (***REMOVED***)` selected as the specific
credentials. See below.

![Jenkins Artifactory upload](documentation/jenkins_build.png)


### New Features
* The new command `publish_artifacts` uploads release artifacts to Artifactory
* ERB trim mode is now enabled (`<% "ruby code" -%>` no longer leaves a newline when rendered)

### New Fixes
* `render_deploys` and `publish_container` can be called in any order in
a project's Jenkins build script because `render_deploys` no longer does
`rm -rf build/kubernetes/` to clean the entire directory and remove
the `images.yaml` artifact created by `publish_container`

