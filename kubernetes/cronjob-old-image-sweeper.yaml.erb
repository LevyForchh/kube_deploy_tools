<% return if config["target"] == "local" %>
apiVersion: batch/v2alpha1
kind: CronJob
metadata:
  namespace: ops
  name: old-images-sweeper
  labels:
    app: old-images-sweeper
    tag: "<%= config["tag"] %>"
spec:
  # Runs to remove old build images from artifactory,
  # GCR and ECR
  schedule: "0 14 * * *"
  jobTemplate:
    spec:
      template:
        metadata:
          name: old-images-sweeper
          labels:
            app: old-images-sweeper
            tag: "<%= config["tag"] %>"
        spec:
          restartPolicy: OnFailure
          # NOTE (efries): prevent a job from retrying forever
          activeDeadlineSeconds: 3600 # deadline of 1h
          containers:
            - name: old-images-sweeper
              image: <%= config["image_registry"] %>/kube_deploy_tools:<%= config["image_tag"] %>
              args: [
                'sweeper',
                '/config/sweeper.yaml',
                <% if config["environment"] == "staging" || config['cloud'] == 'local' %>
                  '--dryrun'
                <% end %>
              ]
              imagePullPolicy: <%= config["pull_policy"] %>
              env:
              - name: ARTIFACTORY_USERNAME
                valueFrom:
                  secretKeyRef:
                    name: artifactory
                    key: username
              - name: ARTIFACTORY_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: artifactory
                    key: password
              - name: ARTIFACTORY_HOST
                valueFrom:
                  secretKeyRef:
                    name: artifactory
                    key: host
              - name: AWS_ACCESS_KEY_ID
                valueFrom:
                  secretKeyRef:
                    name: awsecr-rw
                    key: aws_access_key_id
              - name: AWS_SECRET_ACCESS_KEY
                valueFrom:
                  secretKeyRef:
                    name: awsecr-rw
                    key: aws_secret_access_key
              - name: GOOGLE_APPLICATION_CREDENTIALS
                value: /var/run/secrets/gcr-rw/key.json
              volumeMounts:
              - name: config-sweeper
                mountPath: /config
              - name: service-account
                mountPath: /var/run/secrets/gcr-rw
                readOnly: true
          volumes:
          - name: config-sweeper
            configMap:
              defaultMode: 420
              name: old-images-sweeper
          # Map GCS creds as a JSON file onto the filesystem.
          - name: service-account
            secret:
              secretName: gcr-rw
